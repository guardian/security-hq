Security HQ webapp
==================

This webapp presents the primary interface for Security HQ.

The `watched-account` CloudFormation template will create ConfigRules
that monitor the status of other AWS accounts. This application
presents the data collected by those processes.

It also provides an interface on some markers of a watched AWS
account's health from a security point of view.


## Deployment

The `bundle-hq.sh` script in this repository's TLD will generate an EBS
bundle. This can be run on the stack generated by the `security-hq`
CloudFormation template.

N.B. If you are using macOS you may need to install `coreutils` before you can run the build script:

1) get [Homebrew](https://brew.sh/) if you have not done so already

2) install coreutils using Homebrew `$ brew install coreutils`


## Development

### Getting started

### AWS Configuration
Go to AWS IAM console (security account) and clone `security-hq-dev` user to security-hq-<yourname>
Create an Access key from the Security Credentials tab and save the access key under `security-test` section in your `~/.aws/credentials` file
You should have an entry looks like below
```
[security-test]
aws_access_key_id = xxxxxxxx
aws_secret_access_key = yyyyyyyy
```
Create the entry below in `~/.aws/config` file.
```
[profile security-test]
region = eu-west-1   
```

Ensure that a file named `security-hq.local.conf` exists in your .gu directory, and that it contains the required information, otherwise the project may not run.
Ensure you have `security` account listed in your `security-hq.local.conf` in `AWS_ACCOUNTS` config, like below.

```
AWS_ACCOUNTS=[
    {
     name = "security"
     id   = "security-test"
     roleArn = "dev-local"
    }
]
```

### AWS Security Policies
See ```watched-account``` cloud formation template for the security policies needed to run security-hq.

### Running project
From the root of the project:

1. Run sbt and ensure that it will have access to the application configuration:

`$ ./sbt`

2. Select the project that you want to run, for example:

`$ project hq`

3. Start the application:

`$ run`

Once the sever has started, the webapp should be accessible at http://localhost:9000/

### Using nginx as a proxy

It is possible to run the application and setup nginx as a proxy; this will make the application accessible via the url `https://security-hq.local.dev-gutools.co.uk/` (you may be familiar with this process if you have worked on Identity or Composer):

1. Install nginx:
  > *Linux:*   ```sudo apt-get install nginx```
  >
  > *Mac OSX:* ```brew install nginx```

2. Make sure you have a sites-enabled folder under your nginx home. This should be:
  > *Linux:* ```/etc/nginx/sites-enabled```
  >
  > *Mac OSX:* ```/usr/local/etc/nginx/sites-enabled```

3. Ensure that your nginx.conf (found in the same location as the sites-enabled folder) contains the line `include sites-enabled/*` within the http block, for example:

  ```
  http {
      include sites-enabled/*;
      ...
  }
  ```

4. Checkout the [dev-nginx](https://github.com/guardian/dev-nginx) repo onto your machine and follow the directions regarding installing and trusting the certificates (see [dev-nginx readme](https://github.com/guardian/dev-nginx)).

5. Install the nginx config for the security-hq application:

  ```
    cd <path_of_dev-nginx>
    sudo ./setup-app.rb <path_of_security-hq>/nginx/nginx-mapping.yml
  ```

6. Now when you run the project, it will also be accessible via https://security-hq.local.dev-gutools.co.uk/

### Working with CSS and JS

Security HQ uses [Prettier](https://prettier.io), an opinionated code formatter. This can be run as a pre-commit hook, to format all of the stages changes in the CSS and JS.

1. You will need to install [Yarn](https://yarnpkg.com) to handle the dependencies:
  > *Linux:* Instructions can be found here: https://yarnpkg.com/lang/en/docs/install/#linux-tab
  >
  > *Mac OSX:* `$ brew install yarn`

2. Then install all the dependencies by running:

`$ yarn`


#### Running checks with Yarn

- It is possible to auto-fix all the CSS and JS files:

`$ yarn run prettier`

N.B. The changes will need to be staged afterwards.


- To get detailed information on errors and warnings from the CSS, use:

`$ yarn run sass-lint`

If issues are raised, you can then decide if you want to manually fix them, or run Prettier against the file(s).
