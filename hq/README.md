Security HQ webapp
==================

This webapp presents the primary interface for Security HQ.

The `watched-account` CloudFormation template will create ConfigRules
that monitor the status of other AWS accounts. This application
presents the data collected by those processes.

It also provides an interface on some markers of a watched AWS
account's health from a security point of view.


## Deployment

The `bundle-hq.sh` script in this repository's TLD will generate an EBS
bundle. This can be run on the stack generated by the `security-hq`
CloudFormation template.

N.B. If you are using macOS you may need to install `coreutils` before you can run the build script:

1) get [Homebrew](https://brew.sh/) if you have not done so already

2) install coreutils using Homebrew `$ brew install coreutils`


## Development

### Getting started

### AWS Configuration

Using the Security Admin account, go to AWS IAM console and clone the `security-hq-dev` user to `security-hq-<yourname>`.

At the last step of the creation of this new user, you will be presented with an *Access key ID* and a *Secret access key* that you are going to use during the next step.

Create the file `~/.aws/credentials` with the following contents

```
[security-test]
aws_access_key_id = <Access key ID>
aws_secret_access_key = <Secret Access key>
```

If you already had this file, you should just add this section.

Create the entry below in `~/.aws/config` file.

```
[profile security-test]
region = eu-west-1   
```

The next file is `~/.gu/security-hq.local.conf`, which should be given by one of your team members. Once you have it, make sure to update the value of key `GOOGLE_SERVICE_ACCOUNT_CERT_PATH`. 

Another file you need will need (here again ask for a team member) is `~/.gu/security-hq-service-account-cert.json`.

### AWS Security Policies
See `watched-account` template under `cloudformation` folder for the security policies needed to run security-hq.

### nginx setup

At this step we configure nginx.

1. Install nginx:
  > *Linux:*   ```sudo apt-get install nginx```
  >
  > *Mac OSX:* ```brew install nginx```

2. Make sure you have a sites-enabled folder under your nginx home. This should be:
  > *Linux:* ```/etc/nginx/sites-enabled```
  >
  > *Mac OSX:* ```/usr/local/etc/nginx/sites-enabled```

3. Ensure that your nginx.conf (found in the same location as the sites-enabled folder) contains the line `include sites-enabled/*` within the http block, for example:

  ```
  http {
      include sites-enabled/*;
      ...
  }
  ```

4. Checkout the [dev-nginx](https://github.com/guardian/dev-nginx) repo onto your machine and follow the directions regarding installing and trusting the certificates (see [dev-nginx readme](https://github.com/guardian/dev-nginx)).

5. Install the nginx config for the security-hq application:

  ```
    cd <path_of_dev-nginx>
    sudo ./setup-app.rb <path_of_security-hq>/nginx/nginx-mapping.yml
  ```

6. To stop and restart ngnix you can now do

	```
	sudo nginx -s stop
	sudo nginx
	```

7. Now when you run the project (see next step for details), it will also be accessible via [https://security-hq.local.dev-gutools.co.uk/](https://security-hq.local.dev-gutools.co.uk/)

### Running project
From the root of the project:

1. Run sbt and ensure that it will have access to the application configuration:
`$ ./sbt`

2. Select the project that you want to run:
`sbt:security-hq> project hq`

3. Start the application:
`sbt:security-hq> run`

Once the sever has started, the webapp is accessible at [https://security-hq.local.dev-gutools.co.uk/](https://security-hq.local.dev-gutools.co.uk/)

### Working with CSS and JS

Security HQ uses [Prettier](https://prettier.io) and [ESLint](https://eslint.org/docs/about/) to provide opinionated code formatting and linting. As part of the automated build, all CSS and JS will be validated using the rules of Prettier and ESLint.

#### Testing changes, and passing code validation

Before beginning, you may want to install a node version manager, such as [nvm](https://github.com/creationix/nvm).

1. You will need to install [Yarn](https://yarnpkg.com) to handle the project dependencies:
  > *Linux:* Instructions can be found here: https://yarnpkg.com/lang/en/docs/install/#linux-tab
  >
  > *Mac OSX:* `$ brew install yarn`

2. Then install all the dependencies by running:

`$ yarn`


##### Running checks with Yarn

To see any errors and warnings for the CSS use:

`$ yarn run sass-lint`

To see any errors and warnings for the JS use:

`$ yarn run eslint`

To attempt to auto-fix the CSS and JS, you can try using Prettier:

`$ yarn run prettier`

**N.B. Although Prettier will write to the files, changes will still need to be staged afterwards.**

